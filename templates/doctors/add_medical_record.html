{% extends 'shared/base.html' %}
{% load static %}

{% block title %}New Consultation | {{ patient.user.get_full_name }}{% endblock %}

{% block extra_css %}
<style>
    .form-section-title {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #4a5568;
        letter-spacing: 0.05em;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
    }
    .form-section-title i { margin-right: 0.5rem; color: #3182ce; }
    .form-control:focus { 
        border-color: #3182ce; 
        box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1); 
    }
    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .autocomplete-items div {
        padding: 12px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #edf2f7;
    }
    .autocomplete-items div:hover {
        background-color: #edf2f7;
        color: #3182ce;
    }
    .card {
        border-radius: 15px;
        transition: all 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <form method="post" id="medicalRecordForm">
        {% csrf_token %}
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">
                    <i class="fas fa-file-medical text-primary me-2"></i>Clinical Documentation
                </h1>
                <p class="text-muted small mb-0">
                    Patient: <strong>{{ patient.user.get_full_name }}</strong> | 
                    ID: <span class="badge bg-light text-dark border">{{ patient.patient_id }}</span>
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'patient_detail' patient.id %}" class="btn btn-outline-secondary rounded-pill px-4">
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary rounded-pill px-4 shadow-sm">
                    <i class="fas fa-save me-2"></i>Finalize & Sync to Pharmacy
                </button>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body p-4">
                        <div class="form-section-title">
                            <i class="fas fa-stethoscope"></i>Assessment & Diagnosis
                        </div>
                        
                        <div class="mb-4">
                            <label class="form-label small fw-bold">Presenting Symptoms</label>
                            <textarea name="symptoms" class="form-control" rows="4" 
                                placeholder="Describe patient complaints, onset, and severity..." required></textarea>
                            {% if form.symptoms.errors %}<div class="text-danger small">{{ form.symptoms.errors }}</div>{% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label small fw-bold">Clinical Diagnosis</label>
                            <input type="text" name="diagnosis" class="form-control form-control-lg" 
                                placeholder="Enter primary diagnosis..." required>
                            {% if form.diagnosis.errors %}<div class="text-danger small">{{ form.diagnosis.errors }}</div>{% endif %}
                        </div>

                        <div class="mb-0">
                            <label class="form-label small fw-bold">Additional Clinical Notes (Optional)</label>
                            <textarea name="notes" class="form-control" rows="3" 
                                placeholder="Internal observations or follow-up instructions..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body p-4">
                        <div class="form-section-title">
                            <i class="fas fa-pills"></i>Digital Prescription
                        </div>
                        
                        <div class="position-relative mb-3">
                            <label class="form-label small fw-bold">Medication Fast-Search</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" id="medicationSearch" class="form-control border-start-0" 
                                    placeholder="Type to find medicine...">
                            </div>
                            <div id="autocomplete-list" class="autocomplete-items"></div>
                        </div>

                        <div class="mb-0">
                            <label class="form-label small fw-bold">Dosage & Instructions</label>
                            <textarea name="prescription" id="prescriptionArea" class="form-control" rows="6" 
                                placeholder="Example: Amoxicillin 500mg - 1 tab twice daily for 7 days" required></textarea>
                            <div class="form-text mt-2 text-info small">
                                <i class="fas fa-info-circle me-1"></i>Saving this will alert the Pharmacist immediately.
                            </div>
                            {% if form.prescription.errors %}<div class="text-danger small">{{ form.prescription.errors }}</div>{% endif %}
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        <div class="form-section-title">
                            <i class="fas fa-vial"></i>Laboratory Findings
                        </div>
                        <textarea name="test_results" class="form-control" rows="2" 
                            placeholder="Record rapid test results or vitals here..."></textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // In a real app, this could be an API call to your inventory
    const medications = [
        "Amoxicillin 250mg", "Amoxicillin 500mg", "Paracetamol 500mg", 
        "Metformin 850mg", "Atorvastatin 20mg", "Amlodipine 5mg", 
        "Omeprazole 20mg", "Azithromycin 250mg", "Ibuprofen 400mg", 
        "Salbutamol Inhaler", "Cetirizine 10mg", "Ciprofloxacin 500mg",
        "Losartan 50mg", "Metoprolol 25mg"
    ];

    const searchInput = document.getElementById('medicationSearch');
    const list = document.getElementById('autocomplete-list');
    const prescriptionArea = document.getElementById('prescriptionArea');

    searchInput.addEventListener('input', function() {
        const val = this.value;
        list.innerHTML = '';
        if (!val) return false;

        medications.forEach(med => {
            if (med.toLowerCase().includes(val.toLowerCase())) {
                const item = document.createElement('div');
                // Highlight the matching part
                const matchIndex = med.toLowerCase().indexOf(val.toLowerCase());
                item.innerHTML = med.substring(0, matchIndex) + 
                                 "<strong>" + med.substring(matchIndex, matchIndex + val.length) + "</strong>" + 
                                 med.substring(matchIndex + val.length);
                
                item.addEventListener('click', function() {
                    // Append selected med to the main prescription area
                    const currentVal = prescriptionArea.value;
                    const newline = currentVal.length > 0 ? '\n' : '';
                    prescriptionArea.value = currentVal + newline + med + " - [Dosage]: ";
                    
                    // Reset search
                    searchInput.value = '';
                    list.innerHTML = '';
                    prescriptionArea.focus();
                });
                list.appendChild(item);
            }
        });
    });

    // Close the list if user clicks away
    document.addEventListener('click', function (e) {
        if (e.target !== searchInput) {
            list.innerHTML = '';
        }
    });
</script>
{% endblock %}
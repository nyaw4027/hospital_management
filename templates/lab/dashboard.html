{% extends 'shared/base.html' %}

{% block title %}Lab Management | HMS Core{% endblock %}

{% block content %}
<div class="container py-4">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show rounded-4 border-0 shadow-sm mb-4" role="alert">
                <i class="fas {% if message.tags == 'success' %}fa-check-circle{% else %}fa-exclamation-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-4 bg-primary text-white h-100">
                <h6 class="text-uppercase small fw-bold opacity-75">Monthly Volume ({{ current_month_name }})</h6>
                <h2 class="display-5 fw-bold mb-0">{{ total_monthly_tests|default:0 }}</h2>
                <p class="mb-0 mt-2 small"><i class="fas fa-arrow-up me-1"></i> Total tests processed</p>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
                <h6 class="fw-bold mb-3"><i class="fas fa-chart-bar me-2 text-primary"></i>Test Distribution</h6>
                <div style="height: 180px; position: relative;">
                    <canvas id="labStatsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="fas fa-microscope text-primary me-2"></i>Laboratory Queue</h2>
        <span class="badge bg-success rounded-pill px-3 py-2">{{ waiting_count }} Paid Requests Waiting</span>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-5">
        <div class="card-header bg-white border-0 pt-3 ps-4">
            <h5 class="fw-bold mb-0">Pending Tests</h5>
        </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="bg-light small text-uppercase">
                    <tr>
                        <th class="ps-4">Patient</th>
                        <th>Test Required</th>
                        <th>Requested By</th>
                        <th class="text-end pe-4">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for test in queue %}
                    <tr>
                        <td class="ps-4">
                            <span class="fw-bold d-block">{{ test.patient.name }}</span>
                            <small class="text-muted">ID: #PT-{{ test.patient.id }}</small>
                        </td>
                        <td>
                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                                {{ test.test_name }}
                            </span>
                        </td>
                        <td><small>Dr. {{ test.doctor.get_full_name|default:test.doctor.username }}</small></td>
                        <td class="text-end pe-4">
                            <button class="btn btn-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#uploadModal{{ test.id }}">
                                <i class="fas fa-upload me-1"></i> Upload Results
                            </button>
                        </td>
                    </tr>

                    <div class="modal fade" id="uploadModal{{ test.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 rounded-4 shadow">
                                <div class="modal-header border-0 pb-0">
                                    <h5 class="fw-bold">Submit Results: {{ test.patient.name }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-4">
                                    <form method="POST" action="{% url 'submit_lab_result' test.id %}" enctype="multipart/form-data">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-uppercase">Lab Findings</label>
                                            <textarea name="findings" class="form-control rounded-3" rows="4" placeholder="Enter test results..." required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold text-uppercase">Attachment (PDF/Image)</label>
                                            <input type="file" name="attachment" class="form-control rounded-3">
                                        </div>
                                        <button type="submit" class="btn btn-success w-100 rounded-pill fw-bold py-2 mt-2">
                                            <i class="fas fa-paper-plane me-2"></i>Complete & Notify Doctor
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <i class="fas fa-clipboard-check fa-3x mb-3 opacity-25"></i>
                            <p class="mb-0">Queue is empty. No pending paid requests.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 pt-3 ps-4">
            <h5 class="fw-bold mb-0 text-muted">Recently Completed</h5>
        </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <tbody class="text-muted">
                    {% for test in recent_completions %}
                    <tr>
                        <td class="ps-4" style="width: 30%;">
                            <span class="fw-bold d-block text-dark">{{ test.patient.name }}</span>
                            <small>Completed {{ test.updated_at|timesince }} ago</small>
                        </td>
                        <td>{{ test.test_name }}</td>
                        <td class="text-end pe-4">
                            <a href="{% url 'print_lab_report' test.id %}" target="_blank" class="btn btn-outline-dark btn-sm rounded-pill px-3 me-2">
                                <i class="fas fa-print me-1"></i> Print
                            </a>
                            <a href="{% url 'email_lab_report' test.id %}" class="btn btn-outline-primary btn-sm rounded-pill px-3">
                                <i class="fas fa-envelope me-1"></i> Email
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center py-4 small">No reports ready for printing yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('labStatsChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: 'Tests Count',
                    data: {{ chart_data|safe }},
                    backgroundColor: '#0d6efd20',
                    borderColor: '#0d6efd',
                    borderWidth: 2,
                    borderRadius: 8,
                    barThickness: 25
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#f8f9fa' } },
                    x: { grid: { display: false } }
                }
            }
        });
    });
</script>
{% endblock %}